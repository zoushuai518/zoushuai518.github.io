<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>mysql分布式事务XA - Jekyll</title>
        <!-- meta -->
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="generator" content="Jekyll" />
        <meta name="author" content="邹帅" />
        <meta name="description" content="Just another Jekyll theme design and code by zous.me." />
        <meta name="keywords" content="" />
        <!-- atom -->
        <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
        <link rel="shortcut icon" href="http://jekyllrb.com/favicon.png" type="image/x-icon" />
        <!-- font-awesome -->
        <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Spirax' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/assets/css/syntax.css">
        <link rel="stylesheet" href="/assets/css/main.css">
        
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-56893240-1', 'auto');
          ga('send', 'pageview');

        </script>
        
    </head>
    <body>
        <div class="head fn-clear">
            <div class="header">
                <h1 class="logo">
                    <a href=""><i class="icon-anchor"></i></a>
                </h1>
                <nav class="nav">
                    <ul>
                        
                        
                        
                        <li class="nav-item ">
                            <a href="/index.html">
                                首页
                            </a>
                            
                        </li>
                        
                        
                        
                        <li class="nav-item ">
                            <a href="/categories.html">
                                分类目录
                            </a>
                            
                        </li>
                        
                        
                        
                        <li class="nav-item ">
                            <a href="/archives.html">
                                文章归档
                            </a>
                            
                        </li>
                        
                        
                        
                        <li class="nav-item ">
                            <a href="/links.html">
                                友情链接
                            </a>
                            
                        </li>
                        
                    </ul>
                </nav>
                <div class="follow">
                    
                    <a href="/atom.xml" target="_blank"><i class="icon-rss"></i></a>
                    
                    <a href="http://weibo.com/luoyoo/home" target="_blank"><i class="icon-weibo"></i></a>
                    
                    <a href="https://github.com/zoushuai518" target="_blank"><i class="icon-github-alt"></i></a>
                    
                    <a href="https://twitter.com/zoushuai518" target="_blank"><i class="icon-twitter"></i></a>
                    
                </div>
            </div>
        </div>
        <div class="contain fn-clear">
            <div class="container fn-clear">
                <div class="main">
                    <div class="article article-post">
    <h2 class="title">mysql分布式事务XA</h2>
    <div class="info">
        <span class="info-title"><i class="icon-calendar"></i> Published: </span>
        <span class="info-date">15 Apr 2015</span>
        <span class="info-title"><i class="icon-folder-open"></i> Category: </span>
        <span class="info-link"><a href="/categories.html#mysql-ref" >mysql</a></span>
    </div>
    <p>MySQL XA分为两类，内部XA与外部XA;内部XA用于同一实例下跨多个引擎的事务，由大家熟悉的Binlog作为协调者;外部XA用于跨多MySQL实例的分布式事务，需要应用层介入作为协调者(崩溃时的悬挂事务，全局提交还是回滚，需要由应用层决定，对应用层的实现要求较高);</p>

<p>Binlog作为内部XA的协调者，在binlog中出现的内部xid，在crash recover时，由binlog负责提交。(这是因为，binlog不进行prepare， 只进行commit，因此在binlog中出现的内部xid，一定能够保证其在底层各存储引擎中已经完成prepare)。</p>

<p>MySQL数据库外部XA可以用在分布式数据库代理层，实现对MySQL数据库的分布式事务支持，例如开源的代理工具：网易的DDB，淘宝的TDDL，B2B的Cobar等等。</p>

<p>事务(Transaction)是访问并可能更新数据库中各种数据项的一个程序执行单元；</p>

<p>事务应该具有4个属性：原子性、一致性、隔离性、持续性</p>

<ul>
<li>原子性（atomicity）。一个事务是一个不可分割的工作单位，事务中包括的诸操作要么都做，要么都不做。</li>
<li>一致性（consistency）。事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的。</li>
<li>隔离性（isolation）。一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。</li>
<li>持久性（durability）。持续性也称永久性（permanence），指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。</li>
</ul>

<p>分布式事务：分布式事务的参与者、资源管理器、事务管理器等位于不用的节点上，这些不同的节点相互协作共同完成一个具有逻辑完整性的事务。</p>

<p>XA协议由Tuxedo首先提出的，并交给X/Open组织，作为资源管理器（数据库）与事务管理器的接口标准。目前，Oracle、Informix、DB2和Sybase等各大数据库厂家都提供对XA的支持。XA协议采用两阶段提交方式来管理分布式事务。XA接口提供资源管理器与事务管理器之间进行通信的标准接口。XA协议包括两套函数，以xa<em>开头的及以ax</em>开头的。</p>

<p>Innodb存储引擎支持XA事务，通过XA事务可以支持分布式事务的实现。分布式事务指的是允许多个独立的事务资源（transac tional resources）参与一个全局的事务中。事务资源通常是关系型数据库系统，也可以是其它类型的资源。</p>

<p>全局事务要求在其中所有参与的事务要么全部提交，要么全部回滚，这对于事务原有的ACID要求又有了提高。另外，在使用分布式事务时候，InnoDB存储引擎的事务隔离级别必须设置成serialiable。</p>

<p>分布式事务是由一个或者多个Resource Managerd，一个事务管理器Transaction Manager以及一个应用程序 Application Program组成。</p>

<p>资源管理器：提供访问事务资源的方法，通常一个数据库就是一个资源管理器。</p>

<p>事务管理器：协调参与全局事务中的各个事务。需要和参与全局事务中的资源管理器进行通信。</p>

<p>应用程序：定义事务的边界，指定全局事务中的操作。</p>

<p>在mysql中的分布式事务中，资源管理器就是mysql数据库，事务管理器为连接到mysql服务器的客户端。如下图所示：
<img src="/assets/postImage/mysql/mysql_XA.jpg" alt="mysql分布式事务" title="mysql分布式事务"></p>

<p>分布式事务使用两段式提交（two-phase commit）的方式。在第一个阶段，所有参与全局事务的节点都开始准备，告诉事务管理器它们准备好提交了。第二个阶段，事务管理器告诉资源管理器执行rollback或者commit，如果任何一个节点显示不能commit，那么所有的节点就得全部rollback。</p>

<h4>1.php mysql 简单实现分布式事务思想:</h4>

<p>Mysql完成一个完整xa事务的典型过程:</p>

<pre><code>
XA START 'xatest';
INSERT INTO user VALUES(1,'Colin');
INSERT INTO user VALUES(2,'Colin');
XA END 'xatest';
XA PREPARE 'xatest';
XA COMMIT 'xatest';
</code></pre>

<p>根据2PC，PHP如果想实现跨数据库事务处理，那么他担当的角色相当于事务管理器(TM)<br>
根据2PC,事务过程可细分为3个阶段:</p>

<ul>
<li>1pc</li>
<li>2pc-prepare阶段</li>
<li>2pc-committ阶段</li>
</ul>

<p>1pc，2pc-prepare阶段每个分支事务执行失败应该都不是问题，因为只要在2pc-committ阶段之前，都可以用rollback方法。问题就在于commit阶段，假设第一个分支事务已经执行成功，但是第二个事务执行失败，那么如何保持两个数据库数据一致。事务管理器的作用就是要保证两个数据库的提交都回滚、要么保证数据库的提交都成功。</p>

<p><span class="impor">主流2pc的做法是设法让失败的事务提交成功，而不是让成功的事务回滚。如果非要让成功的事务回滚，那么只能是数据库库管理员根据服务器Log手动回滚了（或者有个补偿式</span></p>

<p>下面就php如何实现2pc-commit阶段关键问题探讨</p>

<p>问题1： 假设有两个分支事务，第一个提交成功了，第二个由于数据库服务器突然宕机导致失败，怎么保证一致性？</p>

<p>问题2： 同样假设有两个分支事务，第一个提交成功了，实际第二个也提交成功了，只是在返回成功消息给PHP端事务管理器（TM）的时候，网络中断，但是TM此时认为第二个事务是失败的，如何处理一致性？</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="lineno"> 1</span> <span class="cp">&lt;?php</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">function</span> <span class="nf">xa_transaction</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 4</span>   <span class="c1">// 假设有两个数据库$db1,$db2</span>
<span class="lineno"> 5</span>   <span class="nv">$dbs</span> <span class="o">=</span> <span class="p">{</span><span class="nv">$db1</span><span class="p">,</span> <span class="nv">$db2</span><span class="p">};</span>
<span class="lineno"> 6</span>   <span class="sd">/** 1pc:          忽略 */</span>
<span class="lineno"> 7</span>   <span class="sd">/** 2pc - prepare 忽略 */</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>   <span class="sd">/** 2pc - committ */</span>
<span class="lineno">10</span>   <span class="c1">// 首先得记录那些失败的分支事务</span>
<span class="lineno">11</span>   <span class="nv">$errs</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="lineno">12</span>   <span class="k">foreach</span><span class="p">(</span><span class="nv">$dbs</span> <span class="k">AS</span> <span class="nv">$db</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">13</span>     <span class="c1">//记录失败的db</span>
<span class="lineno">14</span>     <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">())</span> <span class="p">{</span> 
<span class="lineno">15</span>         <span class="nv">$errs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$db</span><span class="p">;</span>
<span class="lineno">16</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">17</span>         <span class="nx">tm_log</span><span class="p">(</span><span class="s1">&#39;committed&#39;</span><span class="p">)</span> <span class="c1">// 事务管理器日志记录committed.</span>
<span class="lineno">18</span>     <span class="p">}</span>
<span class="lineno">19</span>   <span class="p">}</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>   <span class="c1">// 反复执行那些失败的事务，直到成功（不回滚成功的分支事务，而是提交失败的分支事务）</span>
<span class="lineno">22</span>   <span class="k">foreach</span><span class="p">(</span><span class="nv">$errs</span> <span class="k">AS</span> <span class="nv">$db</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">23</span>     <span class="nv">$prepared_tranaction</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">recover</span><span class="p">();</span> 
<span class="lineno">24</span> 
<span class="lineno">25</span>     <span class="k">if</span><span class="p">(</span><span class="nx">prepared_tranaction</span> <span class="nx">is</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 针对问题2，更新事务管理器日志记录为committed.</span>
<span class="lineno">26</span>       <span class="nx">tm_log</span><span class="p">(</span><span class="s1">&#39;committed&#39;</span><span class="p">)</span> <span class="c1">// 事务管理器日志记录committed.</span>
<span class="lineno">27</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                 <span class="c1">// 针对问题1，重新提交</span>
<span class="lineno">28</span>       
<span class="lineno">29</span>       <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
<span class="lineno">30</span>     <span class="p">}</span>
<span class="lineno">31</span>   <span class="p">}</span>
<span class="lineno">32</span> <span class="p">}</span>
<span class="lineno">33</span> 
<span class="lineno">34</span> <span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>有必要说明的是这里的关键代码: $db-&gt;recover();
其对应着mysql的sql命令xa recover, 该SQL可以查询处当前处于prepared状态还没有committ的事务, 从而可以判定是否要重新提交该分支事务还是简单记录tm端log状态</p>

<p>问题3： 同样假设有两个分支事务，第一个提交成功了，但当刚准备执行第二个事务时，客户端垮掉了。如何保证一致性?</p>

<p>此时，是一个重要的考验TM的地方，它必须有个机制保证客户端重启时，能够重新构造这个全局事务，正确判定其中哪个分支事务没有成功。保证这个机制的实现就是LOG,这个Log在TM端保存，在全局事务的每个关键步骤，TM都应该记录分支事务执行状态，对于该情况导致的问题，当客户端恢复的时候，它分析Log找出失败的事务重新执行其面的提到的xa_transaction()</p>

<p>TM/RM的网络结构，仅供参考:
<img src="/assets/postImage/mysql/mysql_TM-RM.png" alt="mysql TM/RM网络结构" title="mysql TM/RM网络结构"></p>

<h4>2.php简单demo:</h4>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="lineno">  1</span> <span class="cp">&lt;?php</span>
<span class="lineno">  2</span> 
<span class="lineno">  3</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">testAction</span><span class="p">(){</span>
<span class="lineno">  4</span>     <span class="nv">$goods_id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno">  5</span>     <span class="nv">$goods_name</span> <span class="o">=</span> <span class="s2">&quot;大西瓜&quot;</span><span class="p">;</span>
<span class="lineno">  6</span>     <span class="nv">$num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">  7</span>     <span class="nv">$rs_order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="o">-&gt;</span><span class="na">createorder</span><span class="p">(</span><span class="nv">$goods_id</span><span class="p">,</span><span class="nv">$goods_name</span><span class="p">,</span><span class="nv">$num</span><span class="p">);</span>
<span class="lineno">  8</span>     <span class="nv">$rs_goods</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="o">-&gt;</span><span class="na">deduction</span><span class="p">(</span><span class="nv">$goods_id</span><span class="p">,</span><span class="nv">$num</span><span class="p">);</span>
<span class="lineno">  9</span>     <span class="k">if</span><span class="p">(</span><span class="nv">$rs_order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span><span class="s2">&quot;success&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$rs_goods</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;success&quot;</span><span class="p">){</span>
<span class="lineno"> 10</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="o">-&gt;</span><span class="na">commitdb</span><span class="p">(</span><span class="nv">$rs_order</span><span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">]);</span>
<span class="lineno"> 11</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="o">-&gt;</span><span class="na">commitdb1</span><span class="p">(</span><span class="nv">$rs_goods</span><span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">]);</span>
<span class="lineno"> 12</span>     <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="lineno"> 13</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="o">-&gt;</span><span class="na">rollbackdb</span><span class="p">(</span><span class="nv">$rs_order</span><span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">]);</span>
<span class="lineno"> 14</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="o">-&gt;</span><span class="na">rollbackdb1</span><span class="p">(</span><span class="nv">$rs_goods</span><span class="p">[</span><span class="s1">&#39;XA&#39;</span><span class="p">]);</span>
<span class="lineno"> 15</span>     <span class="p">}</span>
<span class="lineno"> 16</span>     <span class="nb">print_r</span><span class="p">(</span><span class="nv">$rs_order</span><span class="p">);</span>
<span class="lineno"> 17</span>     <span class="k">echo</span> <span class="s2">&quot;&lt;br /&gt;&quot;</span><span class="p">;</span>
<span class="lineno"> 18</span>     <span class="nb">print_r</span><span class="p">(</span><span class="nv">$rs_goods</span><span class="p">);</span>
<span class="lineno"> 19</span>     <span class="k">die</span><span class="p">(</span><span class="s2">&quot;dddd&quot;</span><span class="p">);</span>
<span class="lineno"> 20</span> <span class="p">}</span>
<span class="lineno"> 21</span> 
<span class="lineno"> 22</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">createorder</span><span class="p">(</span><span class="nv">$goods_id</span><span class="p">,</span><span class="nv">$goods_name</span><span class="p">,</span><span class="nv">$num</span><span class="p">){</span>
<span class="lineno"> 23</span>     <span class="nv">$XA</span> <span class="o">=</span> <span class="nb">uniqid</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="lineno"> 24</span>     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA START &#39;</span><span class="si">$XA</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno"> 25</span>     <span class="nv">$_rs</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="lineno"> 26</span>     <span class="k">try</span> <span class="p">{</span>
<span class="lineno"> 27</span>         <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="lineno"> 28</span>         <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;V&quot;</span><span class="o">.</span><span class="nb">date</span><span class="p">(</span><span class="s2">&quot;YmdHis&quot;</span><span class="p">);</span>
<span class="lineno"> 29</span>         <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;goods_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$goods_name</span><span class="p">;</span>
<span class="lineno"> 30</span>         <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;goods_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$num</span><span class="p">;</span>
<span class="lineno"> 31</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="s2">&quot;temp_orders&quot;</span><span class="p">,</span><span class="nv">$data</span><span class="p">);</span>
<span class="lineno"> 32</span>         <span class="nv">$rs</span> <span class="o">=</span>  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">lastInsertId</span><span class="p">();</span>
<span class="lineno"> 33</span>         <span class="k">if</span><span class="p">(</span><span class="nv">$rs</span><span class="p">){</span>
<span class="lineno"> 34</span>             <span class="nv">$_rs</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="lineno"> 35</span>         <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="lineno"> 36</span>             <span class="nv">$_rs</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="lineno"> 37</span>         <span class="p">}</span>
<span class="lineno"> 38</span>     <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 39</span>         <span class="nv">$_rs</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="lineno"> 40</span>     <span class="p">}</span>
<span class="lineno"> 41</span>     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA END &#39;</span><span class="si">$XA</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno"> 42</span>         <span class="k">if</span><span class="p">(</span><span class="nv">$_rs</span><span class="p">){</span>
<span class="lineno"> 43</span>                 <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA PREPARE &#39;</span><span class="si">$XA</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno"> 44</span>                 <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;success&quot;</span><span class="p">,</span><span class="s2">&quot;XA&quot;</span><span class="o">=&gt;</span><span class="nv">$XA</span><span class="p">);</span>
<span class="lineno"> 45</span>         <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="lineno"> 46</span>                 <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;nosuccess&quot;</span><span class="p">,</span><span class="s2">&quot;XA&quot;</span><span class="o">=&gt;</span><span class="nv">$XA</span><span class="p">);</span>
<span class="lineno"> 47</span>         <span class="p">}</span>
<span class="lineno"> 48</span> <span class="p">}</span>
<span class="lineno"> 49</span> 
<span class="lineno"> 50</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">deduction</span><span class="p">(</span><span class="nv">$id</span><span class="p">){</span>
<span class="lineno"> 51</span>     <span class="nv">$XA</span> <span class="o">=</span> <span class="nb">uniqid</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="lineno"> 52</span>     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db1</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA START &#39;</span><span class="si">$XA</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno"> 53</span>     <span class="nv">$last_rs</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="lineno"> 54</span>     <span class="k">try</span> <span class="p">{</span>
<span class="lineno"> 55</span>         <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;select * from temp_goods where id = &#39;</span><span class="si">$id</span><span class="s2">&#39; and goods_num&gt;0&quot;</span><span class="p">;</span>
<span class="lineno"> 56</span>         <span class="nv">$rs</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db1</span><span class="o">-&gt;</span><span class="na">fetchRow</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="lineno"> 57</span>         <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$rs</span><span class="p">)){</span>
<span class="lineno"> 58</span>             <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;update temp_goods set goods_num = goods_num-1 where id = &#39;</span><span class="si">$id</span><span class="s2">&#39;&quot;</span><span class="p">;</span>
<span class="lineno"> 59</span>             <span class="nv">$rd</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db1</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="lineno"> 60</span>             <span class="k">if</span><span class="p">(</span><span class="nv">$rd</span><span class="p">){</span>
<span class="lineno"> 61</span>                 <span class="nv">$last_rs</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="lineno"> 62</span>             <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="lineno"> 63</span>                 <span class="nv">$last_rs</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="lineno"> 64</span>             <span class="p">}</span>
<span class="lineno"> 65</span>         <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="lineno"> 66</span>                 <span class="nv">$last_rs</span> <span class="o">=</span> <span class="k">false</span><span class="p">;;</span>
<span class="lineno"> 67</span>         <span class="p">}</span>
<span class="lineno"> 68</span>     <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 69</span>         <span class="nv">$last_rs</span> <span class="o">=</span> <span class="k">false</span><span class="p">;;</span>
<span class="lineno"> 70</span>     <span class="p">}</span>
<span class="lineno"> 71</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db1</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA END &#39;</span><span class="si">$XA</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno"> 72</span> 
<span class="lineno"> 73</span>         <span class="k">if</span><span class="p">(</span><span class="nv">$last_rs</span><span class="p">){</span>
<span class="lineno"> 74</span>             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db1</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA PREPARE &#39;</span><span class="si">$XA</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno"> 75</span>             <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;success&quot;</span><span class="p">,</span><span class="s2">&quot;XA&quot;</span><span class="o">=&gt;</span><span class="nv">$XA</span><span class="p">);</span>
<span class="lineno"> 76</span>         <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="lineno"> 77</span>             <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;nosuccess&quot;</span><span class="p">,</span><span class="s2">&quot;XA&quot;</span><span class="o">=&gt;</span><span class="nv">$XA</span><span class="p">);</span>
<span class="lineno"> 78</span>         <span class="p">}</span>
<span class="lineno"> 79</span> 
<span class="lineno"> 80</span> <span class="p">}</span>
<span class="lineno"> 81</span> 
<span class="lineno"> 82</span> <span class="c1">//提交事务！</span>
<span class="lineno"> 83</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">commitdb</span><span class="p">(</span><span class="nv">$xa</span><span class="p">){</span>
<span class="lineno"> 84</span>     <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA COMMIT &#39;</span><span class="si">$xa</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno"> 85</span> <span class="p">}</span>
<span class="lineno"> 86</span> 
<span class="lineno"> 87</span> <span class="c1">//回滚事务</span>
<span class="lineno"> 88</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">rollbackdb</span><span class="p">(</span><span class="nv">$xa</span><span class="p">){</span>
<span class="lineno"> 89</span>     <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA ROLLBACK &#39;</span><span class="si">$xa</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno"> 90</span> <span class="p">}</span>
<span class="lineno"> 91</span> 
<span class="lineno"> 92</span> <span class="c1">//提交事务！</span>
<span class="lineno"> 93</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">commitdb1</span><span class="p">(</span><span class="nv">$xa</span><span class="p">){</span>
<span class="lineno"> 94</span>     <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db1</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA COMMIT &#39;</span><span class="si">$xa</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno"> 95</span> <span class="p">}</span>
<span class="lineno"> 96</span> 
<span class="lineno"> 97</span> <span class="c1">//回滚事务</span>
<span class="lineno"> 98</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">rollbackdb1</span><span class="p">(</span><span class="nv">$xa</span><span class="p">){</span>
<span class="lineno"> 99</span>     <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db1</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;XA ROLLBACK &#39;</span><span class="si">$xa</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="lineno">100</span> <span class="p">}</span>
<span class="lineno">101</span> 
<span class="lineno">102</span> <span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<ul>
<li><a href="/mysql/2015/04/15/MySQL5.6%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1ID(GTID).html">MySQL5.6全局事务ID(GTID)</a></li>
<li><a href="http://blog.csdn.net/bluishglc/article/details/7612811">关于分布式事务、两阶段提交、一阶段提交、Best Efforts 1PC模式和事务补偿机制的研究</a></li>
</ul>

    <nav class="article-previous fn-clear">
        
        <a class="prev" href="/tool/2015/03/28/%E6%90%AD%E5%BB%BAgit%E6%9C%8D%E5%8A%A1%E5%99%A8.html" rel="bookmark">&laquo;&nbsp;搭建git服务器</a>
        
        
        <a class="next" href="/mysql/2015/04/15/MySQL%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84.html" rel="bookmark">MySQL运行原理与基础架构&nbsp;&raquo;</a>
        
    </nav>
    <div class="comment">
        
        <div id="disqus_thread"></div>
        
    </div>
</div>

                </div>
                <div class="aside">
                    <div class="aside-contact">
                        <h4 class="title">About me</h4>
                        <div class="det fn-clear">
                            <div class="det-image">
                                <img src="https://avatars0.githubusercontent.com/u/5516045?v=3&s=460" />
                            </div>
                            <div class="det-text">
                                <p>我是「邹帅」，目前从事php开发！</p>
                            </div>
                        </div>
                    </div>

                    <div class="aside-item">
                        <h4 class="title">Recent Posts</h4>
                        <ul class="list">
                            
                                <li><a href="/mysql/2015/04/15/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.html" title="mysql分库分表" rel="bookmark">mysql分库分表</a></li>
                            
                                <li><a href="/mysql/2015/04/15/%E4%B8%A4%E9%98%B6%E6%AE%B5%E9%94%81%E5%8D%8F%E8%AE%AE.html" title="mysql两阶段锁协议" rel="bookmark">mysql两阶段锁协议</a></li>
                            
                                <li><a href="/mysql/2015/04/15/%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE.html" title="mysql两阶段提交协议" rel="bookmark">mysql两阶段提交协议</a></li>
                            
                                <li><a href="/mysql/2015/04/15/MySQL5.6%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1ID(GTID).html" title="MySQL 5.6 全局事务 ID（GTID）" rel="bookmark">MySQL 5.6 全局事务 ID（GTID）</a></li>
                            
                                <li><a href="/mysql/2015/04/15/MySQL%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84.html" title="MySQL运行原理与基础架构" rel="bookmark">MySQL运行原理与基础架构</a></li>
                            
                                <li><a href="/mysql/2015/04/15/MySQL%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.html" title="mysql分布式事务XA" rel="bookmark">mysql分布式事务XA</a></li>
                            
                        </ul>
                    </div>

                    <div class="aside-item">
                        <h4 class="title">Links</h4>
                        <ul class="list">
                            
                                
                                    
                                    <li><a href="http://zous.me" title="jz-code" target="_blank">jz-code</a></li>
                                    
                                    <li><a href="http://jekyllrb.com" title="Jekyll" target="_blank">Jekyll</a></li>
                                    
                                
                            
                                
                            
                        </ul>
                    </div>

                </div>
            </div>
        </div>
        <div class="foot">
            <div class="footer">
                <p>Copyright 2013. All rights reserved. Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>, Design by <a href="http://zous.me" target="_blank">zous.me</a>.</p>
            </div>
        </div>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        
            
            <script type="text/javascript">
                //disqus
                var disqus_shortname = 'codemadman';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] ||
                        document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            
        
    </body>
</html>
